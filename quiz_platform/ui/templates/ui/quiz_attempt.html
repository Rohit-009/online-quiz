<!DOCTYPE html>
<html>
<head>
    <title>Quiz Attempt</title>

    <style>

        body{
            margin:0;
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg,#00c6ff,#0072ff);
            display:flex;
            justify-content:center;
            align-items:center;
            min-height:100vh;
            color:#fff;
        }

        .card{
            background: rgba(255,255,255,0.12);
            backdrop-filter: blur(12px);
            padding:30px 40px;
            border-radius:18px;
            width:800px;
            box-shadow:0 0 25px rgba(0,0,0,0.25);
        }

        h2{
            text-align:center;
            margin-top:0;
        }

        #timer{
            background:#ff5252;
            padding:6px 14px;
            border-radius:20px;
            color:white;
            font-weight:bold;
        }

        .topbar{
            display:flex;
            justify-content:space-between;
            margin-bottom:12px;
            font-size:15px;
        }

        .question{
            background:rgba(0,0,0,0.15);
            padding:12px 15px;
            border-radius:12px;
            margin-top:12px;
        }

        .question b{
            font-size:15px;
        }

        input[type=radio]{
            transform:scale(1.2);
            margin-right:6px;
            cursor:pointer;
        }

        #submitBtn{
            margin-top:18px;
            padding:12px;
            width:100%;
            border:none;
            border-radius:10px;
            background:#00ff9c;
            font-weight:bold;
            cursor:pointer;
            font-size:16px;
            color:#111;
        }

        #submitBtn:hover{
            background:#39ffb7;
        }

        #result{
            text-align:center;
            margin-top:10px;
            font-size:18px;
            font-weight:bold;
        }
    </style>
</head>

<body>

<div class="card">

    <h2 id="title"></h2>

    <div class="topbar">
        <div>
            <b>Logged in as:</b> <span id="user"></span>
        </div>

        <div>
            <b>Time Left:</b> <span id="timer">--:--</span>
        </div>
    </div>

    <div id="quiz"></div>

    <button id="submitBtn" onclick="submitQuiz()">Submit Quiz</button>

    <p id="result"></p>

</div>


<script>
// ------------------ GLOBALS ------------------
let timerInterval;

const quiz_id = "{{quiz_id}}";
const answers = {};
const token = localStorage.getItem("token");

// username text
document.getElementById("user").innerHTML =
    localStorage.getItem("username") ?? "User";

// force login protection
if(!token){
    window.location.href="/login/";
}


// ------------------ LOAD QUIZ ------------------
let quizData = sessionStorage.getItem("current_quiz");

if(quizData){
    quizData = JSON.parse(quizData);
    renderQuiz(quizData);
} else {
    fetch("/api/quizzes/" + quiz_id + "/")
    .then(res => res.json())
    .then(data => renderQuiz(data));
}


// ------------------ RENDER QUIZ ------------------
function renderQuiz(data){

    document.getElementById("title").innerHTML = data.title;

    let html = "";

    data.questions.forEach(q => {

        html += `<div class='question'>
                    <p><b>${q.text}</b></p>
        `;

        q.options.forEach(o => {
            html += `
                <label>
                    <input type="radio"
                        name="q${q.id}"
                        value="${o.id}"
                        onchange="answers[${q.id}]='${o.id}'">
                    ${o.text}
                </label><br>
            `;
        });

        html += `</div>`;
    });

    document.getElementById("quiz").innerHTML = html;

    startTimer(60);
}



// ------------------ TIMER ------------------
function startTimer(duration){

    let time = duration;

    timerInterval = setInterval(()=>{

        let minutes = Math.floor(time / 60);
        let seconds = time % 60;

        document.getElementById("timer").innerHTML =
            `${String(minutes).padStart(2,'0')}:${String(seconds).padStart(2,'0')}`;

        if(time <= 0){
            clearInterval(timerInterval);
            document.getElementById("timer").innerHTML = "TIME UP";
            disableOptions();
            submitQuiz(true);
        }

        time--;

    }, 1000);
}

function disableOptions(){
    document.querySelectorAll("input[type=radio]").forEach(el=>{
        el.disabled = true;
    });
}



// ------------------ SUBMIT ------------------
function submitQuiz(auto=false){

    document.getElementById("submitBtn").disabled = true;

    fetch("/api/quizzes/submit/", {
        method: "POST",
        headers:{
            "Content-Type":"application/json",
            "Authorization":"Bearer " + token
        },
        body: JSON.stringify({
            quiz_id: quiz_id,
            answers: answers
        })
    })
    .then(res => res.json())
    .then(data => {

        clearInterval(timerInterval);
        disableOptions();

        sessionStorage.setItem("last_result", JSON.stringify(data));
        sessionStorage.setItem("last_quiz_title",
            document.getElementById("title").innerText);

        window.location.href = "/result/";
    });
}
</script>

</body>
</html>
